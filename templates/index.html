<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Analysis - AI ë¶„ì„ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .chat-container {
            height: calc(100vh - 200px);
            min-height: 400px;
        }
        .message {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .analysis-content {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.8;
        }
        .analysis-content h1, .analysis-content h2, .analysis-content h3 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-weight: bold;
        }
        .analysis-content h1 {
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.3em;
        }
        .analysis-content h2 {
            font-size: 1.3em;
            color: #667eea;
        }
        .analysis-content h3 {
            font-size: 1.1em;
            color: #764ba2;
        }
        .analysis-content code {
            background-color: #f3f4f6;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .analysis-content pre {
            background-color: #1f2937;
            color: #f9fafb;
            padding: 1em;
            border-radius: 6px;
            overflow-x: auto;
        }
        .analysis-content ul, .analysis-content ol {
            margin-left: 1.5em;
            margin-top: 0.5em;
        }
        .analysis-content li {
            margin: 0.3em 0;
        }
        .section-divider {
            border-top: 2px solid #e5e7eb;
            margin: 1.5em 0;
        }
        .copy-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .message:hover .copy-button {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-3xl font-bold">Asset Analysis AI</h1>
            <p class="text-sm mt-2 opacity-90">ì§€ëŠ¥í˜• ìì‚° ë¶„ì„ ë° ë³´ê³ ì„œ ìƒì„± ì‹œìŠ¤í…œ</p>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-6xl mx-auto">
            
            <!-- Status Panel -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                            <span class="text-sm text-gray-600">ì‹œìŠ¤í…œ ìƒíƒœ: <span class="font-semibold text-green-600">ì •ìƒ</span></span>
                        </div>
                        <div class="text-sm text-gray-600">
                            ë¼ìš°íŒ…: <span class="font-semibold" id="current-route">ëŒ€ê¸° ì¤‘</span>
                        </div>
                    </div>
                    <button onclick="clearChat()" class="text-sm text-gray-600 hover:text-red-600 transition">
                        ì±„íŒ… ì´ˆê¸°í™”
                    </button>
                </div>
            </div>

            <!-- Chat Container -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="chat-container overflow-y-auto p-6 space-y-4" id="chatContainer">
                    <!-- Welcome Message -->
                    <div class="message flex items-start space-x-3">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="bg-gray-100 rounded-lg p-4">
                                <p class="text-gray-800">ì•ˆë…•í•˜ì„¸ìš”! Asset Analysis AIì…ë‹ˆë‹¤.</p>
                                <p class="text-gray-600 text-sm mt-2">ê¶ê¸ˆí•˜ì‹  ë‚´ìš©ì„ ì§ˆë¬¸í•´ì£¼ì„¸ìš”. ì›¹ ê²€ìƒ‰, DB ê²€ìƒ‰ì„ í†µí•´ ìë™ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ ë³´ê³ ì„œë¥¼ ìƒì„±í•´ë“œë¦½ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="border-t border-gray-200 p-4 bg-gray-50">
                    <!-- PDF Upload Area -->
                    <div id="pdfUploadArea" class="mb-3 hidden">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                </svg>
                                <div>
                                    <p class="text-sm font-semibold text-blue-900" id="pdfFileName">íŒŒì¼ëª….pdf</p>
                                    <p class="text-xs text-blue-700" id="pdfFileSize">0 KB</p>
                                </div>
                            </div>
                            <button 
                                type="button" 
                                onclick="removePDF()" 
                                class="text-blue-600 hover:text-blue-800 transition"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <form onsubmit="sendMessage(event)" id="messageForm" class="space-y-3">
                        <div class="flex space-x-3">
                            <input 
                                type="text" 
                                id="messageInput" 
                                placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”... (PDF íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë ¤ë©´ ğŸ“ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”)" 
                                class="flex-1 border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                autocomplete="off"
                            >
                            <input 
                                type="file" 
                                id="pdfInput" 
                                accept=".pdf" 
                                class="hidden"
                                onchange="handlePDFSelect(event)"
                            >
                            <button 
                                type="button" 
                                onclick="document.getElementById('pdfInput').click()" 
                                class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-3 rounded-lg transition flex items-center"
                                title="PDF íŒŒì¼ ì—…ë¡œë“œ"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                                </svg>
                            </button>
                            <button 
                                type="submit" 
                                id="sendButton"
                                class="gradient-bg text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition flex items-center space-x-2"
                            >
                                <span>ì „ì†¡</span>
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Info Panel -->
            <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">ì›¹ ê²€ìƒ‰</p>
                            <p class="text-xs text-gray-500">ìµœì‹  ì •ë³´ ì¡°íšŒ</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">DB ê²€ìƒ‰</p>
                            <p class="text-xs text-gray-500">ë‚´ë¶€ ë°ì´í„° ë¶„ì„</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">PDF ë¶„ì„</p>
                            <p class="text-xs text-gray-500">Vantage ë¦¬í¬íŠ¸</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">ë³´ê³ ì„œ ìƒì„±</p>
                            <p class="text-xs text-gray-500">ìë™ ë¬¸ì„œí™”</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const currentRoute = document.getElementById('current-route');
        
        let selectedPDF = null;

        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message flex items-start space-x-3';
            
            if (isUser) {
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0 order-2">
                        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="flex-1 flex justify-end">
                        <div class="bg-purple-600 text-white rounded-lg p-4 max-w-2xl">
                            <p>${content}</p>
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="flex-1 relative">
                        <div class="bg-gray-100 rounded-lg p-4 max-w-4xl analysis-content">
                            <div class="prose prose-sm max-w-none">${formatAnalysisContent(content)}</div>
                        </div>
                        <button 
                            onclick="copyToClipboard(this)" 
                            class="copy-button bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded text-xs"
                            title="ë³µì‚¬"
                        >
                            ğŸ“‹
                        </button>
                    </div>
                `;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addLoader() {
            const loaderDiv = document.createElement('div');
            loaderDiv.className = 'message flex items-start space-x-3';
            loaderDiv.id = 'loader';
            loaderDiv.innerHTML = `
                <div class="flex-shrink-0">
                    <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center">
                        <div class="loader"></div>
                    </div>
                </div>
                <div class="flex-1">
                    <div class="bg-gray-100 rounded-lg p-4">
                        <p class="text-gray-600">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</p>
                    </div>
                </div>
            `;
            chatContainer.appendChild(loaderDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeLoader() {
            const loader = document.getElementById('loader');
            if (loader) {
                loader.remove();
            }
        }

        function handlePDFSelect(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.type !== 'application/pdf') {
                    alert('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                    return;
                }
                
                if (file.size > 50 * 1024 * 1024) {
                    alert('íŒŒì¼ í¬ê¸°ëŠ” 50MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                selectedPDF = file;
                
                // Show PDF info
                document.getElementById('pdfUploadArea').classList.remove('hidden');
                document.getElementById('pdfFileName').textContent = file.name;
                document.getElementById('pdfFileSize').textContent = (file.size / 1024).toFixed(2) + ' KB';
                
                // Update placeholder
                messageInput.placeholder = 'PDFê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...';
            }
        }
        
        function removePDF() {
            selectedPDF = null;
            document.getElementById('pdfUploadArea').classList.add('hidden');
            document.getElementById('pdfInput').value = '';
            messageInput.placeholder = 'ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”... (PDF íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë ¤ë©´ ğŸ“ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”)';
        }

        async function sendMessage(event) {
            event.preventDefault();
            
            const message = messageInput.value.trim();
            if (!message) return;

            // Add user message with PDF indicator
            let displayMessage = message;
            if (selectedPDF) {
                displayMessage += `\n\nğŸ“ ì²¨ë¶€íŒŒì¼: ${selectedPDF.name}`;
            }
            addMessage(displayMessage, true);
            messageInput.value = '';
            
            // Disable input
            messageInput.disabled = true;
            sendButton.disabled = true;
            
            // Show loader
            addLoader();

            try {
                // FormDataë¡œ ì „ì†¡ (PDF í¬í•¨)
                const formData = new FormData();
                formData.append('question', message);
                if (selectedPDF) {
                    formData.append('pdf_file', selectedPDF);
                }
                
                const response = await fetch('/process', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                removeLoader();
                
                if (data.success) {
                    let answerMessage = data.answer;
                    
                    // PDF ë¶„ì„ ì™„ë£Œ í‘œì‹œ
                    if (data.pdf_analyzed) {
                        // PDF ë¶„ì„ í‘œì‹œëŠ” ì´ë¯¸ answerì— í¬í•¨ë˜ì–´ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë³„ë„ ì²˜ë¦¬ ë¶ˆí•„ìš”
                    }
                    
                    addMessage(answerMessage);
                    
                    // ë¼ìš°íŒ… ì •ë³´ ì—…ë°ì´íŠ¸
                    if (data.route) {
                        const routeNames = {
                            'simple_query': 'ê°„ë‹¨ ì¿¼ë¦¬',
                            'vector_rag': 'Economic DB ê²€ìƒ‰',
                            'vector_rag2': 'Production DB ê²€ìƒ‰',
                            'web_search': 'ì›¹ ê²€ìƒ‰',
                            'pdf_reader': 'PDF ë¶„ì„',
                            'both': 'í†µí•© ë¶„ì„ (Economic + Production)',
                            'both_with_pdf': 'í†µí•© ë¶„ì„ (Economic + Production + PDF)'
                        };
                        currentRoute.textContent = routeNames[data.route] || data.route;
                    }
                    
                    // ë¬¸ì„œ ì •ë³´ í‘œì‹œ (ìˆëŠ” ê²½ìš°)
                    if (data.documents && data.documents.length > 0) {
                        console.log(`ì°¸ì¡°ëœ ë¬¸ì„œ ìˆ˜: ${data.documents.length}`);
                    }
                } else {
                    addMessage('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.error);
                }
                
                // Clear PDF after sending
                if (selectedPDF) {
                    removePDF();
                }
            } catch (error) {
                removeLoader();
                addMessage('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                console.error('Error:', error);
            } finally {
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
            }
        }

        function clearChat() {
            if (confirm('ì±„íŒ… ë‚´ì—­ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                chatContainer.innerHTML = `
                    <div class="message flex items-start space-x-3">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="bg-gray-100 rounded-lg p-4">
                                <p class="text-gray-800 font-semibold">ì•ˆë…•í•˜ì„¸ìš”! Asset Analysis AIì…ë‹ˆë‹¤.</p>
                                <p class="text-gray-600 text-sm mt-2">ê¶ê¸ˆí•˜ì‹  ë‚´ìš©ì„ ì§ˆë¬¸í•´ì£¼ì„¸ìš”. ì›¹ ê²€ìƒ‰, DB ê²€ìƒ‰, PDF ë¶„ì„ì„ í†µí•´ ìë™ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ ì „ë¬¸ê°€ ìˆ˜ì¤€ì˜ ë³´ê³ ì„œë¥¼ ìƒì„±í•´ë“œë¦½ë‹ˆë‹¤.</p>
                                <div class="mt-3 text-xs text-gray-500">
                                    <p>ğŸ“„ PDF íŒŒì¼ ì—…ë¡œë“œ ì§€ì›: Vantage Asset/Field Report ë¶„ì„</p>
                                    <p>ğŸ” ìë™ ë¼ìš°íŒ…: ì§ˆë¬¸ ìœ í˜•ì— ë”°ë¼ ìµœì ì˜ ë¶„ì„ ê²½ë¡œ ì„ íƒ</p>
                                    <p>ğŸ“Š í†µí•© ë¶„ì„: Economic, Production, PDF ë°ì´í„°ë¥¼ ì¢…í•©í•œ ìµœì¢… í‰ê°€ ì œê³µ</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                currentRoute.textContent = 'ëŒ€ê¸° ì¤‘';
            }
        }

        function formatAnalysisContent(content) {
            // HTML ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
            const escapeHtml = (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
            
            // ì½”ë“œ ë¸”ë¡ ë¨¼ì € ì²˜ë¦¬ (ë‹¤ë¥¸ ë³€í™˜ ì „ì—)
            const codeBlocks = [];
            let codeBlockIndex = 0;
            formatted = content.replace(/```([\s\S]*?)```/g, (match, code) => {
                const placeholder = `__CODE_BLOCK_${codeBlockIndex}__`;
                codeBlocks[codeBlockIndex] = `<pre class="bg-gray-800 text-gray-100 p-3 rounded my-2 overflow-x-auto"><code>${escapeHtml(code.trim())}</code></pre>`;
                codeBlockIndex++;
                return placeholder;
            });
            
            // ì„¹ì…˜ í—¤ë” í¬ë§·íŒ… (=== ì„¹ì…˜ëª… === ë˜ëŠ” [ì„¹ì…˜ëª…])
            formatted = formatted.replace(/={3,}\s*\n\[([^\]]+)\]\s*\n={3,}/g, 
                '<div class="section-divider"></div><h1 class="text-purple-700 font-bold text-xl mt-6 mb-3">$1</h1>');
            
            // **êµµì€ ê¸€ì”¨** ì²˜ë¦¬ (ì¤‘ì²© ê°€ëŠ¥)
            formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong class="font-semibold text-gray-900">$1</strong>');
            
            // *ê¸°ìš¸ì„* ì²˜ë¦¬ (êµµì€ ê¸€ì”¨ê°€ ì•„ë‹Œ ê²½ìš°ë§Œ)
            formatted = formatted.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em class="italic">$1</em>');
            
            // ë²ˆí˜¸ ìˆëŠ” ë¦¬ìŠ¤íŠ¸ ì²˜ë¦¬ (ë” ì •í™•í•œ íŒ¨í„´)
            formatted = formatted.replace(/^(\d+\.\s+.+(\n(?!\d+\.|\n).+)*)/gm, (match) => {
                const items = match.split(/\n(?=\d+\.)/);
                return '<ol class="list-decimal ml-6 my-2 space-y-1">' + 
                    items.map(item => {
                        const text = item.replace(/^\d+\.\s+/, '');
                        return `<li class="ml-2">${text.trim()}</li>`;
                    }).join('') + 
                    '</ol>';
            });
            
            // ë²ˆí˜¸ ì—†ëŠ” ë¦¬ìŠ¤íŠ¸ ì²˜ë¦¬ (- ë˜ëŠ” â€¢)
            formatted = formatted.replace(/^([\-\â€¢]\s+.+(\n(?![\-\â€¢]|\n).+)*)/gm, (match) => {
                const items = match.split(/\n(?=[\-\â€¢])/);
                return '<ul class="list-disc ml-6 my-2 space-y-1">' + 
                    items.map(item => {
                        const text = item.replace(/^[\-\â€¢]\s+/, '');
                        return `<li class="ml-2">${text.trim()}</li>`;
                    }).join('') + 
                    '</ul>';
            });
            
            // ì¸ë¼ì¸ ì½”ë“œ (`ë¡œ ê°ì‹¸ì§„ ë¶€ë¶„)
            formatted = formatted.replace(/`([^`]+)`/g, '<code class="bg-gray-200 px-1.5 py-0.5 rounded text-sm font-mono">$1</code>');
            
            // ì½”ë“œ ë¸”ë¡ ë³µì›
            codeBlocks.forEach((block, index) => {
                formatted = formatted.replace(`__CODE_BLOCK_${index}__`, block);
            });
            
            // ì¤„ë°”ê¿ˆ ì²˜ë¦¬ (ì´ë¯¸ íƒœê·¸ê°€ ìˆëŠ” ë¶€ë¶„ì€ ì œì™¸)
            formatted = formatted.replace(/\n\n+/g, '</p><p class="my-2">');
            formatted = formatted.replace(/\n(?!<)/g, '<br>');
            
            // ë¬¸ë‹¨ ì‹œì‘/ë íƒœê·¸ ì¶”ê°€ (ì´ë¯¸ íƒœê·¸ê°€ ì—†ëŠ” ê²½ìš°ë§Œ)
            if (!formatted.trim().startsWith('<')) {
                formatted = '<p class="my-2">' + formatted;
            }
            if (!formatted.trim().endsWith('>')) {
                formatted = formatted + '</p>';
            }
            
            return formatted;
        }

        function copyToClipboard(button) {
            const messageDiv = button.closest('.message');
            const contentDiv = messageDiv.querySelector('.analysis-content');
            const text = contentDiv.innerText || contentDiv.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = 'âœ“';
                button.classList.add('bg-green-200');
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('bg-green-200');
                }, 2000);
            }).catch(err => {
                console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }

        // Focus input on load
        messageInput.focus();
    </script>
</body>
</html>

